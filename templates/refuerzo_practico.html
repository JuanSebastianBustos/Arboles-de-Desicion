{% extends "base.html" %} {% block title %}Caso Práctico - Aprendizaje por
Refuerzo{% endblock %} {% block content %}
<div class="container py-4">
  <!-- Header Section -->
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold">
      <i class="fas fa-robot text-primary me-2"></i>
      Caso Práctico: Deep Q-Learning
    </h1>
    <p class="lead text-muted">
      Entrenamiento de un agente para equilibrar el poste en CartPole
    </p>
  </div>

  <!-- Alert Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %} {% if
  messages %} {% for category, message in messages %}
  <div
    class="alert alert-{{ category }} alert-dismissible fade show"
    role="alert"
  >
    <i class="fas fa-info-circle me-2"></i>{{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %} {% endif %} {% endwith %}

  <div class="row g-4 mb-4">
    <!-- Environment Information Card -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-primary text-white border-0">
          <h4 class="card-title mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Entorno: CartPole-v1
          </h4>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <i class="fas fa-shopping-cart fa-4x text-primary"></i>
          </div>

          <h5 class="mb-3">Objetivo</h5>
          <p>
            Mantener el poste en posición vertical el mayor tiempo posible
            aplicando fuerzas al carrito.
          </p>

          <h5 class="mb-3">Especificaciones</h5>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between">
              <strong>Estados:</strong>
              <span class="badge bg-info">4 dimensiones</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <strong>Acciones:</strong>
              <span class="badge bg-success">2 posibles</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <strong>Máx. pasos:</strong>
              <span class="badge bg-warning text-dark">500</span>
            </li>
          </ul>

          <div class="mt-3">
            <h6 class="fw-bold">Estados observables:</h6>
            <ul class="small">
              <li>Posición del carrito</li>
              <li>Velocidad del carrito</li>
              <li>Ángulo del poste</li>
              <li>Velocidad angular del poste</li>
            </ul>
          </div>

          <div class="mt-3">
            <h6 class="fw-bold">Acciones disponibles:</h6>
            <ul class="small">
              <li><strong>0:</strong> Empujar hacia la izquierda</li>
              <li><strong>1:</strong> Empujar hacia la derecha</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Training Control Panel -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-success text-white border-0">
          <h4 class="card-title mb-0">
            <i class="fas fa-sliders-h me-2"></i>
            Panel de Control
          </h4>
        </div>
        <div class="card-body">
          <form
            id="trainingForm"
            method="POST"
            action="{{ url_for('refuerzo_practico') }}"
          >
            <input type="hidden" name="action" value="train" />

            <div class="mb-4">
              <label for="n_episodes" class="form-label fw-bold">
                <i class="fas fa-layer-group me-1"></i>
                Número de episodios
              </label>
              <input
                type="number"
                class="form-control form-control-lg"
                id="n_episodes"
                name="n_episodes"
                min="10"
                max="1000"
                value="100"
                required
              />
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Recomendado: 500 episodios
              </div>
            </div>

            <div class="mb-4">
              <h6 class="fw-bold">Hiperparámetros del modelo:</h6>
              <ul class="list-unstyled small text-muted">
                <li><strong>α (learning rate):</strong> 0.001</li>
                <li><strong>γ (discount factor):</strong> 0.99</li>
                <li><strong>ε inicial:</strong> 1.0</li>
                <li><strong>ε mínimo:</strong> 0.01</li>
                <li><strong>Decay de ε:</strong> 0.995</li>
                <li><strong>Batch size:</strong> 32</li>
              </ul>
            </div>

            <button
              type="submit"
              class="btn btn-success btn-lg w-100"
              id="trainBtn"
            >
              <i class="fas fa-play me-2"></i>
              Iniciar Entrenamiento
            </button>
            {% if is_training %}
            <div class="alert alert-info mt-3" role="alert">
              <div class="d-flex align-items-center">
                <div
                  class="spinner-border spinner-border-sm me-2"
                  role="status"
                ></div>
                <div>
                  <strong>Entrenamiento en progreso...</strong>
                  <br />
                  <small
                    >Recarga la página en unos minutos para ver los
                    resultados.</small
                  >
                </div>
              </div>
            </div>
            {% endif %} {% if training_stats and training_stats.trained %}
            <div class="mt-3">
              <button
                type="submit"
                name="action"
                value="test"
                class="btn btn-info btn-lg w-100"
              >
                <i class="fas fa-vial me-2"></i>
                Probar Agente Entrenado
              </button>
            </div>
            <div class="mt-3">
              <button
                type="submit"
                name="action"
                value="reset"
                class="btn btn-warning btn-lg w-100"
                onclick="return confirm('¿Estás seguro de reiniciar? Se perderá el modelo entrenado.')"
              >
                <i class="fas fa-redo me-2"></i>
                Reiniciar Modelo
              </button>
            </div>
            {% endif %}
          </form>

          <!-- Loading indicator -->
          <div
            id="loadingIndicator"
            class="alert alert-info mt-3 d-none"
            role="alert"
          >
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Entrenando...</span>
              </div>
              <div>
                <strong>Entrenando agente...</strong>
                <br />
                <small>Este proceso puede tardar varios minutos.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Statistics -->
  {% if training_stats and training_stats.trained %}
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body text-center">
          <div
            class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
            style="width: 60px; height: 60px"
          >
            <i class="fas fa-layer-group fa-lg"></i>
          </div>
          <h6 class="text-muted text-uppercase mb-2">Episodios</h6>
          <h2 class="display-6 fw-bold text-primary mb-0">
            {{ training_stats.n_episodes }}
          </h2>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body text-center">
          <div
            class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
            style="width: 60px; height: 60px"
          >
            <i class="fas fa-trophy fa-lg"></i>
          </div>
          <h6 class="text-muted text-uppercase mb-2">Recompensa Final</h6>
          <h2 class="display-6 fw-bold text-success mb-0">
            {{ "%.1f"|format(training_stats.final_avg) }}
          </h2>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body text-center">
          <div
            class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
            style="width: 60px; height: 60px"
          >
            <i class="fas fa-star fa-lg"></i>
          </div>
          <h6 class="text-muted text-uppercase mb-2">Mejor Recompensa</h6>
          <h2 class="display-6 fw-bold text-warning mb-0">
            {{ "%.0f"|format(training_stats.max_reward) }}
          </h2>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 card-hover">
        <div class="card-body text-center">
          <div
            class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
            style="width: 60px; height: 60px"
          >
            <i class="fas fa-search fa-lg"></i>
          </div>
          <h6 class="text-muted text-uppercase mb-2">Epsilon Final</h6>
          <h2 class="display-6 fw-bold text-info mb-0">
            {{ "%.3f"|format(training_stats.final_epsilon) }}
          </h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Progress Chart -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-dark text-white border-0">
      <h5 class="card-title mb-0">
        <i class="fas fa-chart-line me-2"></i>
        Evolución del Entrenamiento
      </h5>
    </div>
    <div class="card-body text-center">
      {% if plot_image %}
      <img
        src="data:image/png;base64,{{ plot_image }}"
        alt="Progreso de entrenamiento"
        class="img-fluid rounded shadow"
        style="max-height: 600px"
      />
      <p class="text-muted mt-3 mb-0">
        <small>
          Gráfico superior: Recompensa por episodio y promedio móvil (100
          episodios)
          <br />
          Gráfico inferior: Decaimiento de epsilon (exploración → explotación)
        </small>
      </p>
      {% else %}
      <p class="text-muted">No hay datos de entrenamiento disponibles</p>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Test Results -->
  {% if test_results %}
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-info text-white border-0">
      <h5 class="card-title mb-0">
        <i class="fas fa-vial me-2"></i>
        Resultados de Prueba
      </h5>
    </div>
    <div class="card-body">
      {% if test_results.error %}
      <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ test_results.error }}
      </div>
      {% else %}
      <div class="row">
        <div class="col-md-4 text-center mb-3">
          <h6 class="text-muted text-uppercase">Recompensa Promedio</h6>
          <h2 class="display-4 fw-bold text-info">
            {{ "%.1f"|format(test_results.avg_reward) }}
          </h2>
        </div>
        <div class="col-md-4 text-center mb-3">
          <h6 class="text-muted text-uppercase">Máximo</h6>
          <h2 class="display-4 fw-bold text-success">
            {{ "%.0f"|format(test_results.max_reward) }}
          </h2>
        </div>
        <div class="col-md-4 text-center mb-3">
          <h6 class="text-muted text-uppercase">Mínimo</h6>
          <h2 class="display-4 fw-bold text-warning">
            {{ "%.0f"|format(test_results.min_reward) }}
          </h2>
        </div>
      </div>

      <hr class="my-4" />

      <h6 class="fw-bold mb-3">Recompensas por episodio de prueba:</h6>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th class="text-center">Episodio</th>
              <th class="text-center">Recompensa</th>
            </tr>
          </thead>
          <tbody>
            {% for reward in test_results.rewards %}
            <tr>
              <td class="text-center">{{ loop.index }}</td>
              <td class="text-center">
                <span
                  class="badge {% if reward >= 400 %}bg-success{% elif reward >= 200 %}bg-info{% else %}bg-warning text-dark{% endif %}"
                >
                  {{ "%.0f"|format(reward) }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Interpretation Guide -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-secondary text-white border-0">
      <h5 class="card-title mb-0">
        <i class="fas fa-question-circle me-2"></i>
        Guía de Interpretación
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6 class="fw-bold">¿Qué significan las recompensas?</h6>
          <ul class="small">
            <li>
              <strong>Recompensa = 500:</strong> Rendimiento perfecto (límite
              del entorno)
            </li>
            <li><strong>Recompensa > 400:</strong> Excelente desempeño</li>
            <li><strong>Recompensa > 200:</strong> Buen desempeño</li>
            <li>
              <strong>Recompensa < 100:</strong> El agente necesita más
              entrenamiento
            </li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6 class="fw-bold">Indicadores de convergencia:</h6>
          <ul class="small">
            <li>El promedio móvil se estabiliza en valores altos</li>
            <li>Epsilon decae hasta el mínimo configurado</li>
            <li>La varianza entre episodios disminuye</li>
            <li>El agente mantiene el poste vertical consistentemente</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="d-flex justify-content-between my-4">
    <a
      href="{{ url_for('refuerzo_conceptos') }}"
      class="btn btn-outline-primary d-flex align-items-center"
    >
      <i class="fas fa-arrow-left me-2"></i>
      Conceptos Básicos
    </a>
    <a
      href="{{ url_for('index') }}"
      class="btn btn-primary d-flex align-items-center"
    >
      <i class="fas fa-home me-2"></i>
      Volver al Inicio
    </a>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Show loading indicator when training starts
  document
    .getElementById("trainingForm")
    .addEventListener("submit", function (e) {
      const action = e.submitter.value;
      if (action === "train") {
        document.getElementById("loadingIndicator").classList.remove("d-none");
        document.getElementById("trainBtn").disabled = true;
      }
    });

  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(
    document.querySelectorAll('[data-bs-toggle="tooltip"]')
  );
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
</script>
{% endblock %}
